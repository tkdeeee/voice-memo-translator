{"version":3,"file":"blob_writer.umd.js","sources":["blob_writer.js"],"sourcesContent":["/*jslint browser */\n\nimport {Capacitor, registerPlugin} from \"@capacitor/core\";\nimport {Filesystem} from \"@capacitor/filesystem\";\n\nconst BlobWriter = registerPlugin(\"BlobWriter\");\n\nfunction array_buffer_to_base64(buffer) {\n    return window.btoa(\n        Array.from(new Uint8Array(buffer)).map(function (byte) {\n            return String.fromCharCode(byte);\n        }).join(\"\")\n    );\n}\n\nfunction write_file_via_indexeddb({\n    path,\n    directory,\n    blob,\n    recursive\n}) {\n\n// Firstly, create the file entry in the database. This populates a bunch of\n// properties on the entry, such as mtime, ctime and type, and also gives the\n// Filesystem plugin a chance to initialize its database.\n\n    return Filesystem.writeFile({\n        directory,\n        path,\n        recursive,\n        data: \"\"\n    }).then(function () {\n\n// Now reach into IndexedDB and assign 'blob' to the file entry.\n\n        return new Promise(function (resolve, reject) {\n            function fail(event) {\n                reject(event.target.error);\n            }\n            const connection = window.indexedDB.open(\"Disc\");\n            connection.onerror = fail;\n            connection.onsuccess = function () {\n                const db = connection.result;\n                const transaction = db.transaction(\"FileStorage\", \"readwrite\");\n                transaction.onerror = fail;\n                const store = transaction.objectStore(\"FileStorage\");\n                const name = `/${directory}/${path.replace(/^\\//, \"\")}`;\n                const load = store.get(name);\n                load.onsuccess = function () {\n                    load.result.size = blob.size;\n                    load.result.content = blob;\n                    const put = store.put(load.result);\n                    put.onsuccess = function () {\n                        resolve(undefined);\n                    };\n                };\n            };\n        });\n    });\n}\n\nfunction write_file_via_bridge({\n    path,\n    directory,\n    blob,\n    recursive\n}) {\n\n// Firstly, create or truncate the file.\n\n    return Filesystem.writeFile({\n        directory,\n        path,\n        recursive,\n        data: \"\"\n    }).then(function consume_blob() {\n\n// Now write the file incrementally so that we do not exhaust our memory in\n// attempting to Base64 encode the entire Blob at once.\n\n        if (blob.size === 0) {\n            return Promise.resolve();\n        }\n\n// By choosing a chunk size which is a multiple of 3, we avoid a bug in\n// Filesystem.appendFile, only on the web platform, which corrupts files by\n// inserting Base64 padding characters within the file. See\n// https://github.com/ionic-team/capacitor-plugins/issues/649.\n\n        const chunk_size = 3 * 128 * 1024;\n        const chunk_blob = blob.slice(0, chunk_size);\n        blob = blob.slice(chunk_size);\n\n// Read the Blob as an ArrayBuffer, then append it to the file on disk.\n\n        return new Response(\n            chunk_blob\n        ).arrayBuffer(\n        ).then(function append_chunk_to_file(buffer) {\n            return Filesystem.appendFile({\n                directory,\n                path,\n                data: array_buffer_to_base64(buffer)\n            });\n        }).then(\n            consume_blob\n        );\n    });\n}\n\nfunction write_blob(options) {\n    const {\n        path,\n        directory,\n        blob,\n        fast_mode = false,\n        recursive,\n        on_fallback\n    } = options;\n    if (\n        !blob\n        || !Number.isSafeInteger(blob.size)\n        || typeof blob.type !== \"string\"\n    ) {\n        return Promise.reject(new Error(\"Not a Blob.\"));\n    }\n    if (Capacitor.getPlatform() === \"web\") {\n        return (\n            fast_mode\n            ? write_file_via_indexeddb(options)\n            : write_file_via_bridge(options)\n        );\n    }\n    return Promise.all([\n        BlobWriter.get_config(),\n        Filesystem.getUri({path, directory})\n    ]).then(function ([config, file_info]) {\n        const absolute_path = file_info.uri.replace(\"file://\", \"\");\n\n// The built-in CapacitorHttp plugin can be configured to monkey patch the\n// global 'fetch' function, but that forces 'blob' over the bridge which is\n// what we're trying to avoid. We attempt to subvert the monkey patching.\n\n        const real_fetch = window.CapacitorWebFetch || window.fetch;\n        return real_fetch(\n            config.base_url + absolute_path + (\n                recursive\n                ? \"?recursive=true\"\n                : \"\"\n            ),\n            {\n                headers: {authorization: config.auth_token},\n                method: \"put\",\n                body: blob\n            }\n        ).then(function (response) {\n            if (response.status !== 204) {\n                throw new Error(\"Bad HTTP status: \" + response.status);\n            }\n\n// Producing a file URI is deprecated. In the next major version, the returned\n// Promise should resolve to undefined.\n\n            return file_info.uri;\n        });\n    }).catch(function on_fail(error) {\n        if (on_fallback !== undefined) {\n            on_fallback(error);\n        }\n        return write_file_via_bridge(options);\n    });\n}\n\nexport default Object.freeze(write_blob);\n"],"names":["registerPlugin","Filesystem","Capacitor"],"mappings":"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"}